From 9461d2645fb4e2fbc53718856702319fcd8587d1 Mon Sep 17 00:00:00 2001
From: Persian Prince <persianpros@yahoo.com>
Date: Sun, 19 Jan 2020 11:03:42 +0100

---
 source3/auth/auth_domain.c                |  2 ++
 source3/librpc/rpc/rpc_common.c           |  2 ++
 source3/libsmb/trusts_util.c              | 11 +++++++++++
 source3/nmbd/nmbd_processlogon.c          |  4 ++++
 source3/rpc_client/cli_pipe.c             |  4 ++++
 source3/rpc_server/rpc_ep_setup.c         |  5 +++++
 source3/rpc_server/srv_pipe.c             |  2 ++
 source3/rpc_server/svcctl/srv_svcctl_nt.c |  2 ++
 source3/rpc_server/wkssvc/srv_wkssvc_nt.c |  8 ++++++++
 source3/rpcclient/rpcclient.c             |  2 ++
 source3/smbd/process.c                    |  2 ++
 source3/smbd/server_exit.c                |  2 ++
 12 files changed, 46 insertions(+)

diff --git a/source3/auth/auth_domain.c b/source3/auth/auth_domain.c
index 8a71603..ca97192 100644
--- a/source3/auth/auth_domain.c
+++ b/source3/auth/auth_domain.c
@@ -538,7 +538,9 @@ static NTSTATUS auth_init_trustdomain(struct auth_context *auth_context, const c
 
 NTSTATUS auth_domain_init(void) 
 {
+#ifdef NETLOGON_SUPPORT
 	smb_register_auth(AUTH_INTERFACE_VERSION, "trustdomain", auth_init_trustdomain);
 	smb_register_auth(AUTH_INTERFACE_VERSION, "ntdomain", auth_init_ntdomain);
+#endif
 	return NT_STATUS_OK;
 }
diff --git a/source3/librpc/rpc/rpc_common.c b/source3/librpc/rpc/rpc_common.c
index 319757f..a077696 100644
--- a/source3/librpc/rpc/rpc_common.c
+++ b/source3/librpc/rpc/rpc_common.c
@@ -103,9 +103,11 @@ static bool initialize_interfaces(void)
 	if (!smb_register_ndr_interface(&ndr_table_samr)) {
 		return false;
 	}
+#ifdef NETLOGON_SUPPORT
 	if (!smb_register_ndr_interface(&ndr_table_netlogon)) {
 		return false;
 	}
+#endif
 	if (!smb_register_ndr_interface(&ndr_table_srvsvc)) {
 		return false;
 	}
diff --git a/source3/libsmb/trusts_util.c b/source3/libsmb/trusts_util.c
index 71435b8..1c5d31e 100644
--- a/source3/libsmb/trusts_util.c
+++ b/source3/libsmb/trusts_util.c
@@ -46,9 +46,11 @@ NTSTATUS trust_pw_change_and_store_it(struct rpc_pipe_client *cli, TALLOC_CTX *m
 	NTSTATUS nt_status;
 
 	switch (sec_channel_type) {
+#ifdef NETLOGON_SUPPORT
 	case SEC_CHAN_WKSTA:
 	case SEC_CHAN_DOMAIN:
 		break;
+#endif
 	default:
 		return NT_STATUS_NOT_SUPPORTED;
 	}
@@ -159,6 +161,11 @@ bool enumerate_domain_trusts( TALLOC_CTX *mem_ctx, const char *domain,
 	*num_domains = 0;
 	*sids = NULL;
 
+#ifndef NETLOGON_SUPPORT
+	return False;
+#endif
+
+
 	/* lookup a DC first */
 
 	if ( !get_dc_name(domain, NULL, dc_name, &dc_ss) ) {
@@ -243,6 +250,10 @@ NTSTATUS change_trust_account_password( const char *domain, const char *remote_m
 	struct cli_state *cli = NULL;
 	struct rpc_pipe_client *netlogon_pipe = NULL;
 
+#ifndef NETLOGON_SUPPORT
+	return NT_STATUS_UNSUCCESSFUL;
+#endif
+
 	DEBUG(5,("change_trust_account_password: Attempting to change trust account password in domain %s....\n",
 		domain));
 
diff --git a/source3/nmbd/nmbd_processlogon.c b/source3/nmbd/nmbd_processlogon.c
index 9bb1252..8c6b078 100644
--- a/source3/nmbd/nmbd_processlogon.c
+++ b/source3/nmbd/nmbd_processlogon.c
@@ -320,6 +320,10 @@ void process_logon_packet(struct packet_struct *p, const char *buf,int len,
 	NTSTATUS status;
 	const char *pdc_name;
 
+#ifndef NETLOGON_SUPPORT
+	return;
+#endif
+
 	in_addr_to_sockaddr_storage(&ss, p->ip);
 	pss = iface_ip((struct sockaddr *)&ss);
 	if (!pss) {
diff --git a/source3/rpc_client/cli_pipe.c b/source3/rpc_client/cli_pipe.c
index b25e739..fbc9513 100644
--- a/source3/rpc_client/cli_pipe.c
+++ b/source3/rpc_client/cli_pipe.c
@@ -2221,6 +2221,10 @@ static void rpc_pipe_bind_step_two_trigger(struct tevent_req *req)
 				      struct schannel_state);
 	struct tevent_req *subreq;
 
+#ifndef NETLOGON_SUPPORT
+	tevent_req_nterror(req, NT_STATUS_UNSUCCESSFUL);
+	return;
+#endif
 	if (schannel_auth == NULL ||
 	    !ndr_syntax_id_equal(&state->cli->abstract_syntax,
 				 &ndr_table_netlogon.syntax_id)) {
diff --git a/source3/rpc_server/rpc_ep_setup.c b/source3/rpc_server/rpc_ep_setup.c
index d44ca2c..72c9b29 100644
--- a/source3/rpc_server/rpc_ep_setup.c
+++ b/source3/rpc_server/rpc_ep_setup.c
@@ -606,6 +606,7 @@ static bool samr_init_cb(void *ptr)
 	return true;
 }
 
+#ifdef NETLOGON_SUPPORT
 static bool netlogon_init_cb(void *ptr)
 {
 	struct dcesrv_ep_context *ep_ctx =
@@ -654,6 +655,7 @@ static bool netlogon_init_cb(void *ptr)
 
 	return true;
 }
+#endif
 
 static bool spoolss_init_cb(void *ptr)
 {
@@ -1116,12 +1118,15 @@ bool dcesrv_ep_setup(struct tevent_context *ev_ctx,
 		return false;
 	}
 
+#ifdef NETLOGON_SUPPORT
 	netlogon_cb.init         = netlogon_init_cb;
 	netlogon_cb.shutdown     = NULL;
 	netlogon_cb.private_data = ep_ctx;
 	if (!NT_STATUS_IS_OK(rpc_netlogon_init(&netlogon_cb))) {
 		return false;
 	}
+#endif
+
 
 	rpcsrv_type = lp_parm_const_string(GLOBAL_SECTION_SNUM,
 					   "rpc_server",
diff --git a/source3/rpc_server/srv_pipe.c b/source3/rpc_server/srv_pipe.c
index b9f759d..12f6bfd 100644
--- a/source3/rpc_server/srv_pipe.c
+++ b/source3/rpc_server/srv_pipe.c
@@ -421,10 +421,12 @@ static bool check_bind_req(struct pipes_struct *p,
 	if (ok) {
 		context_fns->allow_connect = false;
 	}
+#ifdef NETLOGON_SUPPORT
 	ok = ndr_syntax_id_equal(abstract, &ndr_table_netlogon.syntax_id);
 	if (ok) {
 		context_fns->allow_connect = false;
 	}
+#endif
 	/*
 	 * for the epmapper and echo interfaces we allow "connect"
 	 * auth_level by default.
diff --git a/source3/rpc_server/svcctl/srv_svcctl_nt.c b/source3/rpc_server/svcctl/srv_svcctl_nt.c
index 9d51c89..25c663e 100644
--- a/source3/rpc_server/svcctl/srv_svcctl_nt.c
+++ b/source3/rpc_server/svcctl/srv_svcctl_nt.c
@@ -91,9 +91,11 @@ bool init_service_op_table( void )
 	i++;
 #endif
 
+#ifdef NETLOGON_SUPPORT
 	svcctl_ops[i].name = talloc_strdup( svcctl_ops, "NETLOGON" );
 	svcctl_ops[i].ops  = &netlogon_svc_ops;
 	i++;
+#endif
 
 #ifdef WINREG_SUPPORT
 	svcctl_ops[i].name = talloc_strdup( svcctl_ops, "RemoteRegistry" );
diff --git a/source3/rpc_server/wkssvc/srv_wkssvc_nt.c b/source3/rpc_server/wkssvc/srv_wkssvc_nt.c
index be16250..1b417d7 100644
--- a/source3/rpc_server/wkssvc/srv_wkssvc_nt.c
+++ b/source3/rpc_server/wkssvc/srv_wkssvc_nt.c
@@ -824,6 +824,10 @@ WERROR _wkssvc_NetrJoinDomain2(struct pipes_struct *p,
 	WERROR werr;
 	struct security_token *token = p->session_info->security_token;
 
+#ifndef NETLOGON_SUPPORT
+	return WERR_NOT_SUPPORTED;
+#endif
+
 	if (!r->in.domain_name) {
 		return WERR_INVALID_PARAM;
 	}
@@ -901,6 +905,10 @@ WERROR _wkssvc_NetrUnjoinDomain2(struct pipes_struct *p,
 	WERROR werr;
 	struct security_token *token = p->session_info->security_token;
 
+#ifndef NETLOGON_SUPPORT
+	return WERR_NOT_SUPPORTED;
+#endif
+
 	if (!r->in.account || !r->in.encrypted_password) {
 		return WERR_INVALID_PARAM;
 	}
diff --git a/source3/rpcclient/rpcclient.c b/source3/rpcclient/rpcclient.c
index 1ca9ee9..c735a18 100644
--- a/source3/rpcclient/rpcclient.c
+++ b/source3/rpcclient/rpcclient.c
@@ -627,7 +627,9 @@ static struct cmd_set *rpcclient_command_list[] = {
 #ifdef PRINTER_SUPPORT
 	spoolss_commands,
 #endif
+#ifdef NETLOGON_SUPPORT
 	netlogon_commands,
+#endif
 	srvsvc_commands,
 #ifdef DFS_SUPPORT
 	dfs_commands,
diff --git a/source3/smbd/process.c b/source3/smbd/process.c
index 67ad318..59859bc 100644
--- a/source3/smbd/process.c
+++ b/source3/smbd/process.c
@@ -2431,8 +2431,10 @@ static bool housekeeping_fn(const struct timeval *now, void *private_data)
 	/* check if we need to reload services */
 	check_reload(sconn, time_mono(NULL));
 
+#ifdef NETLOGON_SUPPORT
 	/* Change machine password if neccessary. */
 	attempt_machine_password_change();
+#endif
 
         /*
 	 * Force a log file check.
diff --git a/source3/smbd/server_exit.c b/source3/smbd/server_exit.c
index 1876386..d601e9e 100644
--- a/source3/smbd/server_exit.c
+++ b/source3/smbd/server_exit.c
@@ -156,7 +156,9 @@ static void exit_server_common(enum server_exit_reason how,
 		rpc_winreg_shutdown();
 #endif
 
+#ifdef NETLOGON_SUPPORT
 		rpc_netlogon_shutdown();
+#endif
 		rpc_samr_shutdown();
 		rpc_lsarpc_shutdown();
 	}
