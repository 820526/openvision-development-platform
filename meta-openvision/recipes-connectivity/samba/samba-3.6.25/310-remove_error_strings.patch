From 1ac5a80467d2f9bf1ee654aadf8f211d99aeda27 Mon Sep 17 00:00:00 2001
From: Persian Prince <persianpros@yahoo.com>
Date: Sun, 19 Jan 2020 11:03:42 +0100

---
 source3/libsmb/nterr.c                | 8 ++++++++
 source3/rpc_client/cli_pipe.c         | 6 ------
 source3/rpc_server/srv_pipe.c         | 4 ----
 source3/script/mkbuildoptions-waf.awk | 2 +-
 source3/script/mkbuildoptions.awk     | 2 +-
 5 files changed, 10 insertions(+), 12 deletions(-)

diff --git a/source3/libsmb/nterr.c b/source3/libsmb/nterr.c
index e48f221..55d4f01 100644
--- a/source3/libsmb/nterr.c
+++ b/source3/libsmb/nterr.c
@@ -702,6 +702,7 @@ const char *nt_errstr(NTSTATUS nt_code)
 					NT_STATUS_DOS_CODE(nt_code));
 	}
 
+#ifdef VERBOSE_ERROR
 	while (nt_errs[idx].nt_errstr != NULL) {
 		if (NT_STATUS_V(nt_errs[idx].nt_errcode) ==
 		    NT_STATUS_V(nt_code)) {
@@ -709,6 +710,7 @@ const char *nt_errstr(NTSTATUS nt_code)
 		}
 		idx++;
 	}
+#endif
 
 	result = talloc_asprintf(talloc_tos(), "NT code 0x%08x",
 				 NT_STATUS_V(nt_code));
@@ -724,12 +726,14 @@ const char *get_friendly_nt_error_msg(NTSTATUS nt_code)
 {
 	int idx = 0;
 
+#ifdef VERBOSE_ERROR
 	while (nt_err_desc[idx].nt_errstr != NULL) {
 		if (NT_STATUS_V(nt_err_desc[idx].nt_errcode) == NT_STATUS_V(nt_code)) {
 			return nt_err_desc[idx].nt_errstr;
 		}
 		idx++;
 	}
+#endif
 
 	/* fall back to NT_STATUS_XXX string */
 
@@ -745,6 +749,7 @@ const char *get_nt_error_c_code(NTSTATUS nt_code)
 	char *result;
 	int idx = 0;
 
+#ifdef VERBOSE_ERROR
 	while (nt_errs[idx].nt_errstr != NULL) {
 		if (NT_STATUS_V(nt_errs[idx].nt_errcode) ==
 		    NT_STATUS_V(nt_code)) {
@@ -752,6 +757,7 @@ const char *get_nt_error_c_code(NTSTATUS nt_code)
 		}
 		idx++;
 	}
+#endif
 
 	result = talloc_asprintf(talloc_tos(), "NT_STATUS(0x%08x)",
 				 NT_STATUS_V(nt_code));
@@ -767,12 +773,14 @@ NTSTATUS nt_status_string_to_code(const char *nt_status_str)
 {
 	int idx = 0;
 
+#ifdef VERBOSE_ERROR
 	while (nt_errs[idx].nt_errstr != NULL) {
 		if (strcasecmp(nt_errs[idx].nt_errstr, nt_status_str) == 0) {
 			return nt_errs[idx].nt_errcode;
 		}
 		idx++;
 	}
+#endif
 	return NT_STATUS_UNSUCCESSFUL;
 }
 
diff --git a/source3/rpc_client/cli_pipe.c b/source3/rpc_client/cli_pipe.c
index fbc9513..fb2b63c 100644
--- a/source3/rpc_client/cli_pipe.c
+++ b/source3/rpc_client/cli_pipe.c
@@ -445,7 +445,6 @@ static NTSTATUS cli_pipe_validate_current_pdu(TALLOC_CTX *mem_ctx,
 				  rpccli_pipe_txt(talloc_tos(), cli),
 				  pkt->ptype, expected_pkt_type,
 				  nt_errstr(ret)));
-			NDR_PRINT_DEBUG(ncacn_packet, pkt);
 			return ret;
 		}
 
@@ -466,7 +465,6 @@ static NTSTATUS cli_pipe_validate_current_pdu(TALLOC_CTX *mem_ctx,
 				  rpccli_pipe_txt(talloc_tos(), cli),
 				  pkt->ptype, expected_pkt_type,
 				  nt_errstr(ret)));
-			NDR_PRINT_DEBUG(ncacn_packet, pkt);
 			return ret;
 		}
 
@@ -486,7 +484,6 @@ static NTSTATUS cli_pipe_validate_current_pdu(TALLOC_CTX *mem_ctx,
 				  rpccli_pipe_txt(talloc_tos(), cli),
 				  pkt->ptype, expected_pkt_type,
 				  nt_errstr(ret)));
-			NDR_PRINT_DEBUG(ncacn_packet, pkt);
 			return ret;
 		}
 
@@ -508,7 +505,6 @@ static NTSTATUS cli_pipe_validate_current_pdu(TALLOC_CTX *mem_ctx,
 				  rpccli_pipe_txt(talloc_tos(), cli),
 				  pkt->ptype, expected_pkt_type,
 				  nt_errstr(ret)));
-			NDR_PRINT_DEBUG(ncacn_packet, pkt);
 			return ret;
 		}
 
@@ -526,7 +522,6 @@ static NTSTATUS cli_pipe_validate_current_pdu(TALLOC_CTX *mem_ctx,
 				  rpccli_pipe_txt(talloc_tos(), cli),
 				  pkt->ptype, expected_pkt_type,
 				  nt_errstr(ret)));
-			NDR_PRINT_DEBUG(ncacn_packet, pkt);
 			return ret;
 		}
 
@@ -570,7 +565,6 @@ static NTSTATUS cli_pipe_validate_current_pdu(TALLOC_CTX *mem_ctx,
 				  rpccli_pipe_txt(talloc_tos(), cli),
 				  pkt->ptype, expected_pkt_type,
 				  nt_errstr(ret)));
-			NDR_PRINT_DEBUG(ncacn_packet, pkt);
 			return ret;
 		}
 
diff --git a/source3/rpc_server/srv_pipe.c b/source3/rpc_server/srv_pipe.c
index ac7fe89..2b9f495 100644
--- a/source3/rpc_server/srv_pipe.c
+++ b/source3/rpc_server/srv_pipe.c
@@ -996,7 +996,6 @@ static bool api_pipe_bind_req(struct pipes_struct *p,
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(1, ("api_pipe_bind_req: invalid pdu: %s\n",
 			  nt_errstr(status)));
-		NDR_PRINT_DEBUG(ncacn_packet, pkt);
 		goto err_exit;
 	}
 
@@ -1330,7 +1329,6 @@ bool api_pipe_bind_auth3(struct pipes_struct *p, struct ncacn_packet *pkt)
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(1, ("api_pipe_bind_auth3: invalid pdu: %s\n",
 			  nt_errstr(status)));
-		NDR_PRINT_DEBUG(ncacn_packet, pkt);
 		goto err;
 	}
 
@@ -1488,7 +1486,6 @@ static bool api_pipe_alter_context(struct pipes_struct *p,
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(1, ("api_pipe_alter_context: invalid pdu: %s\n",
 			  nt_errstr(status)));
-		NDR_PRINT_DEBUG(ncacn_packet, pkt);
 		goto err_exit;
 	}
 
@@ -2062,7 +2059,6 @@ static bool process_request_pdu(struct pipes_struct *p, struct ncacn_packet *pkt
 	if (!NT_STATUS_IS_OK(status)) {
 		DEBUG(1, ("process_request_pdu: invalid pdu: %s\n",
 			  nt_errstr(status)));
-		NDR_PRINT_DEBUG(ncacn_packet, pkt);
 		set_incoming_fault(p);
 		return false;
 	}
diff --git a/source3/script/mkbuildoptions-waf.awk b/source3/script/mkbuildoptions-waf.awk
index ddb3f65..17401ab 100644
--- a/source3/script/mkbuildoptions-waf.awk
+++ b/source3/script/mkbuildoptions-waf.awk
@@ -55,7 +55,7 @@ BEGIN {
 	print "****************************************************************************/";
 	print "void build_options(bool screen)";
 	print "{";
-	print "       if ((DEBUGLEVEL < 4) && (!screen)) {";
+	print "       if ((DEBUGLEVEL < 4) || (!screen)) {";
 	print "	       return;";
 	print "       }";
 	print "";
diff --git a/source3/script/mkbuildoptions.awk b/source3/script/mkbuildoptions.awk
index 9a82da2..20a50bb 100644
--- a/source3/script/mkbuildoptions.awk
+++ b/source3/script/mkbuildoptions.awk
@@ -55,7 +55,7 @@ BEGIN {
 	print "****************************************************************************/";
 	print "void build_options(bool screen)";
 	print "{";
-	print "       if ((DEBUGLEVEL < 4) && (!screen)) {";
+	print "       if ((DEBUGLEVEL < 4) || (!screen)) {";
 	print "	       return;";
 	print "       }";
 	print "";
